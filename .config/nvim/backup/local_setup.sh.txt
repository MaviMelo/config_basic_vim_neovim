#!/bin/bash

# AUTOMATIZA√á√ÉO DE INSTALA√á√ÉO DE DEPENDENCIAS PARA NEOVIM.

# üîç Verifica√ß√£o de ambiente
check_root() {
    [ "$(id -u)" -ne 0 ] && echo -e "\033[1;31m‚úñ Execute como sudo!\033[0m" && exit 1
}

# üõ†Ô∏è Instala√ß√£o robusta do LuaRocks
install_luarocks() {
    echo -e "\033[1;34m‚ñ∂ Verificando LuaRocks...\033[0m"
    
    if ! command -v luarocks &>/dev/null; then
        echo -e "\033[1;33m‚úî Instalando LuaRocks...\033[0m"
        apt-get install -y lua5.3 liblua5.3-dev
        wget https://luarocks.org/releases/luarocks-3.9.2.tar.gz
        tar zxpf luarocks-3.9.2.tar.gz
        cd luarocks-3.9.2 || exit
        ./configure --with-lua-include=/usr/include/lua5.3
        make && make install
        cd .. && rm -rf luarocks-3.9.2*
        
        # Adiciona ao PATH se necess√°rio
        echo 'export PATH="$PATH:/usr/local/bin"' >> /etc/profile
        source /etc/profile
    else
        echo -e "\033[1;32m‚úî LuaRocks j√° instalado ($(luarocks --version | head -n1))\033[0m"
    fi

    # Garante luacheck instalado
    if ! luarocks list | grep -q "luacheck"; then
        luarocks install luacheck
        echo -e "\033[1;32m‚úî Luacheck instalado\033[0m"
    else
        echo -e "\033[1;32m‚úî Luacheck j√° presente\033[0m"
    fi
}

# üì¶ Instala√ß√£o segura de depend√™ncias
install_deps() {
    local deps=(git curl python3-pip nodejs npm php-cli shellcheck build-essential)
    
npm install -g prettier

    echo -e "\033[1;34m‚ñ∂ Verificando depend√™ncias...\033[0m"
    for dep in "${deps[@]}"; do
        if ! dpkg -l | grep -q "^ii  ${dep} "; then
            apt-get install -y "${dep}" || echo -e "\033[1;31m‚úñ Falha ao instalar ${dep}\033[0m"
        fi
    done
}

# üßπ Instala√ß√£o limpa de Linters
install_linters() {
    # JavaScript/TypeScript
    npm install -g eslint_d @typescript-eslint/parser @typescript-eslint/eslint-plugin
    
    # Python
    pip3 install pylint flake8 --upgrade
    
    # PHP
    wget -O /usr/local/bin/phpcs https://squizlabs.github.io/PHP_CodeSniffer/phpcs.phar
    chmod +x /usr/local/bin/phpcs
    
    # Shell
    apt-get install -y shellcheck
}

# üéØ P√≥s-instala√ß√£o
post_install() {
    echo -e "\033[1;36m\n‚úÖ Instala√ß√£o Conclu√≠da!\033[0m"
    echo -e "\033[1;37mLinters dispon√≠veis:\033[0m"
    echo -e "‚Ä¢ Lua: $(luarocks list | grep luacheck)"
    echo -e "‚Ä¢ JS/TS: $(eslint_d --version)"
    echo -e "‚Ä¢ Python: $(pylint --version | head -n1)"
    echo -e "‚Ä¢ PHP: $(phpcs --version)"
    echo -e "‚Ä¢ Shell: $(shellcheck --version | head -n2)"
}

# ‚öôÔ∏è Execu√ß√£o Principal
check_root
install_deps
install_luarocks  # Agora com tratamento robusto!
install_linters
post_install
